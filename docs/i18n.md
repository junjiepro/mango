# 国际化 (i18n) 指南

本项目使用 `next-intl` 实现国际化，支持中文（简体）和英文。

## 快速开始

### 支持的语言

- **中文 (zh)**: 默认语言
- **英文 (en)**: 可选语言

### 路由模式

项目采用基于路径的语言路由：

- 中文（默认）: `https://example.com/`
- 英文: `https://example.com/en/`

## 架构概览

### 目录结构

```
src/
├── app/
│   ├── [locale]/           # 语言路由目录
│   │   ├── layout.tsx      # 语言特定布局
│   │   ├── page.tsx        # 主页
│   │   ├── login/          # 登录页面
│   │   └── register/       # 注册页面
│   └── layout.tsx          # 根布局
├── components/
│   ├── LanguageSwitcher.tsx    # 语言切换器组件
│   ├── I18nErrorBoundary.tsx   # i18n 错误边界
│   └── auth/               # 认证组件
├── i18n/
│   ├── request.ts          # 服务器端 i18n 配置
│   └── routing.ts          # 路由配置
├── lib/
│   ├── i18n.ts            # i18n 工具函数
│   └── i18n-performance.ts   # 性能优化工具
├── hooks/
│   └── useI18n.ts         # 自定义 i18n hooks
└── types/
    └── i18n.ts            # i18n 类型定义

messages/
├── zh.json                 # 中文翻译
└── en.json                 # 英文翻译
```

### 核心组件

1. **路由配置** (`src/i18n/routing.ts`)
2. **服务器配置** (`src/i18n/request.ts`)
3. **语言切换器** (`src/components/LanguageSwitcher.tsx`)
4. **错误边界** (`src/components/I18nErrorBoundary.tsx`)

## 使用方法

### 在组件中使用翻译

#### 服务器组件

```tsx
import { getTranslations } from 'next-intl/server'

export default async function Page() {
  const t = await getTranslations('navigation')

  return (
    <div>
      <h1>{t('title')}</h1>
      <p>{t('description')}</p>
    </div>
  )
}
```

#### 客户端组件

```tsx
'use client'

import { useTranslations } from 'next-intl'

export default function Component() {
  const t = useTranslations('common')

  return (
    <button>{t('submit')}</button>
  )
}
```

### 翻译文件结构

翻译文件使用嵌套的 JSON 结构：

```json
{
  "common": {
    "loading": "加载中...",
    "submit": "提交",
    "cancel": "取消"
  },
  "navigation": {
    "home": "首页",
    "login": "登录",
    "register": "注册"
  },
  "auth": {
    "login": {
      "title": "登录",
      "emailLabel": "邮箱地址",
      "passwordLabel": "密码"
    }
  }
}
```

### 参数插值

支持动态参数：

```json
{
  "welcome": "欢迎，{name}！",
  "itemCount": "共有 {count} 个项目"
}
```

```tsx
const t = useTranslations('common')

// 使用
t('welcome', { name: '张三' })  // "欢迎，张三！"
t('itemCount', { count: 5 })    // "共有 5 个项目"
```

### 复数形式

```json
{
  "items": {
    "zero": "没有项目",
    "one": "1 个项目",
    "other": "{count} 个项目"
  }
}
```

```tsx
t('items', { count: 0 })  // "没有项目"
t('items', { count: 1 })  // "1 个项目"
t('items', { count: 5 })  // "5 个项目"
```

## 语言切换

### 使用语言切换器组件

```tsx
import LanguageSwitcher from '@/components/LanguageSwitcher'

export default function Navbar() {
  return (
    <nav>
      {/* 其他导航项 */}
      <LanguageSwitcher />
    </nav>
  )
}
```

### 编程式语言切换

```tsx
import { useRouter, usePathname } from '@/i18n/routing'

export default function Component() {
  const router = useRouter()
  const pathname = usePathname()

  const switchToEnglish = () => {
    router.push(pathname, { locale: 'en' })
  }

  return (
    <button onClick={switchToEnglish}>
      Switch to English
    </button>
  )
}
```

## 性能优化

### 翻译文件懒加载

系统自动实现翻译文件的懒加载和缓存：

```tsx
import { useOptimizedTranslations } from '@/lib/i18n-performance'

export default function Component() {
  const { translations, loading, error } = useOptimizedTranslations('zh')

  if (loading) return <div>Loading translations...</div>
  if (error) return <div>Failed to load translations</div>

  return <div>{/* 正常渲染 */}</div>
}
```

### 性能监控

```tsx
import { useI18nPerformanceMonitor } from '@/lib/i18n-performance'

export default function AdminPanel() {
  const { metrics, cacheStatus } = useI18nPerformanceMonitor()

  return (
    <div>
      <p>缓存命中率: {metrics.cacheHits / (metrics.cacheHits + metrics.cacheMisses)}</p>
      <p>平均加载时间: {metrics.loadTime}ms</p>
      <p>缓存的语言: {cacheStatus.locales.join(', ')}</p>
    </div>
  )
}
```

## 错误处理

### 错误边界

系统提供自动的错误边界处理：

```tsx
import { I18nErrorBoundary } from '@/components/I18nErrorBoundary'

export default function Page() {
  return (
    <I18nErrorBoundary fallback={<div>翻译加载失败</div>}>
      <YourComponent />
    </I18nErrorBoundary>
  )
}
```

### 自定义错误处理

```tsx
import { useI18nErrorHandler } from '@/components/I18nErrorBoundary'

export default function Component() {
  const { handleI18nError } = useI18nErrorHandler()

  const loadContent = async () => {
    try {
      // 加载内容
    } catch (error) {
      const result = handleI18nError(error)
      if (result.isI18nError) {
        // 处理 i18n 错误
        console.log(result.fallbackText)
      }
    }
  }
}
```

## 类型安全

### 翻译键类型检查

系统提供翻译键的 TypeScript 类型支持：

```tsx
import type { TranslationKeys } from '@/types/i18n'

// 编译时类型检查
const t = useTranslations('common')
t('submit')      // ✅ 正确
t('invalid-key') // ❌ 编译错误
```

### 自定义翻译 Hook

```tsx
import { useTypedTranslations } from '@/hooks/useI18n'

export default function Component() {
  const { t, locale, isLoading } = useTypedTranslations('auth.login')

  return (
    <form>
      <label>{t('emailLabel')}</label>
      <input type="email" />

      <label>{t('passwordLabel')}</label>
      <input type="password" />

      <button disabled={isLoading}>
        {t('submitButton')}
      </button>
    </form>
  )
}
```

## 开发工具

### 翻译验证

运行翻译文件完整性检查：

```bash
npm run validate-translations
```

### 测试

运行国际化相关测试：

```bash
# 单元测试
npm run test -- tests/i18n

# 端到端测试
npm run test:e2e -- tests/integration/language-switching.spec.ts
```

## 部署注意事项

### 环境变量

确保在生产环境中设置以下环境变量：

```env
NEXT_PUBLIC_DEFAULT_LOCALE=zh
NEXT_PUBLIC_SUPPORTED_LOCALES=zh,en
```

### 服务器配置

确保服务器支持语言路径的重写规则。

### CDN 配置

如果使用 CDN，确保正确处理语言路径的缓存策略。

## 故障排除

### 常见问题

1. **翻译不显示**: 检查翻译键是否存在于对应的翻译文件中
2. **路由错误**: 验证 `src/i18n/routing.ts` 配置是否正确
3. **性能问题**: 使用性能监控工具检查缓存命中率

### 调试技巧

```tsx
// 在开发环境中显示翻译键
const t = useTranslations('common')

// 开发模式下显示翻译键
const debugT = (key: string, params?: any) => {
  const translation = t(key, params)
  if (process.env.NODE_ENV === 'development') {
    console.log(`Translation key: ${key}, value: ${translation}`)
  }
  return translation
}
```

## 贡献指南

### 添加新语言

1. 在 `src/i18n/routing.ts` 中添加新的 locale
2. 创建对应的翻译文件 `messages/{locale}.json`
3. 更新类型定义
4. 添加相应的测试

### 添加新翻译

1. 在所有语言的翻译文件中添加新的键值对
2. 运行 `npm run validate-translations` 验证完整性
3. 更新相关的 TypeScript 类型定义
4. 添加使用示例到文档

## 性能基准

- **首次加载**: < 100ms
- **语言切换**: < 50ms
- **缓存命中率**: > 95%
- **翻译文件大小**: < 50KB (gzipped)

## 参考资源

- [next-intl 官方文档](https://next-intl-docs.vercel.app/)
- [Next.js 国际化指南](https://nextjs.org/docs/advanced-features/i18n)
- [React i18n 最佳实践](https://react.i18next.com/)